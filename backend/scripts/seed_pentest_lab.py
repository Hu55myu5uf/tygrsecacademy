"""
Seed script for Advanced Pentest Lab
Creates a lab entry with Guacamole access to Kali attack machine + vulnerable targets
"""
import sys
import os
from sqlalchemy.orm import Session

# Add parent dir to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from database.connection import SessionLocal
from models.labs import Lab, LabDifficulty, LabType
import models.user  # Register User model

def seed_pentest_lab():
    db = SessionLocal()
    try:
        print("Seeding Advanced Pentest Lab...")
        
        lab_data = {
            "title": "Advanced Penetration Testing Lab",
            "description": "Full pentest environment with Kali Linux attack machine and multiple vulnerable targets. Access via Apache Guacamole VNC.",
            "docker_image": "kalilinux/kali-rolling",
            "difficulty": LabDifficulty.ADVANCED,
            "category": "Penetration Testing",
            "estimated_minutes": 120,
            "lab_type": LabType.GUACAMOLE,
            "guacamole_url": "http://localhost:8085/guacamole",
            "compose_file": os.path.abspath(os.path.join(
                os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 
                "docker", "pentest-lab", "docker-compose.yml"
            )),
            "content": """
# Advanced Penetration Testing Lab

## Introduction
This lab provides a complete penetration testing environment with a **Kali Linux** attack machine and multiple vulnerable targets.

## Environment Overview

### Attack Machine
- **Kali Linux** - Full desktop via VNC
- Pre-installed: nmap, nikto, sqlmap, firefox, etc.

### Target Machines
| Target | Description | Access |
|--------|-------------|--------|
| **DVWA** | Damn Vulnerable Web App | http://dvwa (from Kali) |
| **Juice Shop** | OWASP Juice Shop | http://juice-shop:3000 (from Kali) |
| **SSH Server** | Vulnerable Ubuntu SSH | ssh root@vulnerable-ssh |

## Getting Started

### 1. Access Guacamole
Open: **http://localhost:8085/guacamole**
- Username: `tygr`
- Password: `tygrsec123`

### 2. Select Connection
Click **"Kali Attack Machine"** to open Kali desktop

### 3. Open Terminal
Right-click desktop â†’ "Open Terminal Here"

## Exercises

### Exercise 1: Network Discovery
```bash
# Scan the lab network
nmap -sn 172.28.0.0/16

# Identify services
nmap -sV dvwa juice-shop vulnerable-ssh
```

### Exercise 2: DVWA Exploitation
```bash
# Open Firefox in Kali
firefox http://dvwa &

# Login: admin / password
# Set security to LOW
# Try SQL injection: 1' OR '1'='1
```

### Exercise 3: Juice Shop
```bash
# Open Juice Shop
firefox http://juice-shop:3000 &

# Challenge: Find the hidden admin page
# Challenge: Perform XSS attack
```

### Exercise 4: SSH Brute Force
```bash
# Try common credentials
ssh root@vulnerable-ssh
# Password: root
```

### Exercise 5: SQLMap
```bash
# Automated SQL injection on DVWA
sqlmap -u "http://dvwa/vulnerabilities/sqli/?id=1&Submit=Submit" --cookie="PHPSESSID=xxx;security=low" --dbs
```

## Tips
- Use `nmap -A` for aggressive scanning
- Check robots.txt for hidden paths
- Try default credentials first
- Document your findings!

> **Warning:** This is an isolated lab network. Never attack systems without permission.
"""
        }

        existing = db.query(Lab).filter(Lab.title == lab_data["title"]).first()
        if existing:
            print(f"Updating existing lab: {existing.title}")
            for key, value in lab_data.items():
                setattr(existing, key, value)
        else:
            print(f"Creating new lab: {lab_data['title']}")
            lab = Lab(**lab_data)
            db.add(lab)
        
        db.commit()
        print("Advanced Pentest Lab seeded successfully!")
        print(f"\nTo start the lab infrastructure, run:")
        print(f"  cd docker/pentest-lab")
        print(f"  docker compose up -d")
        print(f"\nThen access Guacamole at: http://localhost:8085/guacamole")
        print(f"  Username: tygr")
        print(f"  Password: tygrsec123")

    except Exception as e:
        print(f"Error seeding lab: {e}")
        import traceback
        traceback.print_exc()
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    seed_pentest_lab()
